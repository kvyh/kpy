<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>SEDMrph.zeropoint &mdash; SEDM Pipeline 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="SEDM Pipeline 0.1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for SEDMrph.zeropoint</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Thu Dec  3 14:57:05 2015</span>

<span class="sd">@author: nadiablago</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">zscale</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">pyfits</span> <span class="kn">as</span> <span class="nn">pf</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">pywcs</span> 
<span class="kn">from</span> <span class="nn">astropy.io.votable</span> <span class="kn">import</span> <span class="n">parse_single_table</span>
<span class="kn">import</span> <span class="nn">coordinates_conversor</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">app_phot</span>
<span class="kn">from</span> <span class="nn">numpy.lib</span> <span class="kn">import</span> <span class="n">recfunctions</span> <span class="k">as</span> <span class="n">rfn</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="kn">as</span> <span class="nn">opt</span>
<span class="kn">import</span> <span class="nn">fitsutils</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">transformations</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>

<div class="viewcode-block" id="are_isolated"><a class="viewcode-back" href="../../SEDMrph.html#SEDMrph.zeropoint.are_isolated">[docs]</a><span class="k">def</span> <span class="nf">are_isolated</span><span class="p">(</span><span class="n">rav</span><span class="p">,</span> <span class="n">decv</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns a mask saying whether the stars with coordinates rav, decv are isolated in a radius of r arcsec.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rav</span><span class="p">))</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rav</span><span class="p">)):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">coordinates_conversor</span><span class="o">.</span><span class="n">get_distance</span><span class="p">(</span><span class="n">rav</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">decv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rav</span><span class="p">[</span><span class="n">index</span><span class="o">!=</span><span class="n">i</span><span class="p">],</span> <span class="n">decv</span><span class="p">[</span><span class="n">index</span><span class="o">!=</span><span class="n">i</span><span class="p">])</span>
        <span class="n">mask</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">~</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">d</span><span class="o">*</span><span class="mi">3600</span><span class="o">&lt;</span><span class="n">r</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span></div>

<div class="viewcode-block" id="twoD_Gaussian"><a class="viewcode-back" href="../../SEDMrph.html#SEDMrph.zeropoint.twoD_Gaussian">[docs]</a><span class="k">def</span> <span class="nf">twoD_Gaussian</span><span class="p">(</span><span class="n">xdata_tuple</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Produces a 2D gaussian centered in xo, yo with the parameters specified.</span>
<span class="sd">    xdata_tuple: coordinates of the points where the 2D Gaussian is computed.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">xdata_tuple</span>                                                        
    <span class="n">xo</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">xo</span><span class="p">)</span>                                                              
    <span class="n">yo</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">yo</span><span class="p">)</span>                                                              
    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>   
    <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">theta</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">sigma_x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">theta</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">sigma_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>    
    <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>   
    <span class="n">g</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">amplitude</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">xo</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">xo</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">yo</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">yo</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>                                   
    <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="twoD_Gauss_test"><a class="viewcode-back" href="../../SEDMrph.html#SEDMrph.zeropoint.twoD_Gauss_test">[docs]</a><span class="k">def</span> <span class="nf">twoD_Gauss_test</span><span class="p">(</span><span class="n">theta</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Generates a test Gaussian and fits it using the scisoft optimization software.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Create x and y indices</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    
    <span class="c1">#create data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">twoD_Gaussian</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    
    <span class="c1"># plot twoD_Gaussian data generated above</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="mi">201</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    
    <span class="c1"># add some noise to the data and try to fit the data generated beforehand</span>
    <span class="n">initial_guess</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
    
    <span class="n">data_noisy</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="mf">0.2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    
    <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">curve_fit</span><span class="p">(</span><span class="n">twoD_Gaussian</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">data_noisy</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">initial_guess</span><span class="p">)</span>
    
    <span class="n">data_fitted</span> <span class="o">=</span> <span class="n">twoD_Gaussian</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data_noisy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="mi">201</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
        <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">data_fitted</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="mi">201</span><span class="p">),</span> <span class="mi">8</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="find_fwhm"><a class="viewcode-back" href="../../SEDMrph.html#SEDMrph.zeropoint.find_fwhm">[docs]</a><span class="k">def</span> <span class="nf">find_fwhm</span><span class="p">(</span><span class="n">imfile</span><span class="p">,</span> <span class="n">xpos</span><span class="p">,</span> <span class="n">ypos</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Finds and returns the best parameters for the FWHM in arcsec for the stars marked with X, Y</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">f</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">imfile</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">pix2ang</span> <span class="o">=</span> <span class="mf">0.394</span>
    <span class="n">def_fwhm</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">/</span><span class="n">pix2ang</span>
    <span class="n">rad</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">30.</span><span class="o">/</span><span class="n">pix2ang</span><span class="p">)</span>
    
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xpos</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;detected&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;fwhm&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)])</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x_i</span><span class="p">,</span><span class="n">y_i</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span> <span class="n">ypos</span><span class="p">)):</span>
        <span class="n">hrad</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">rad</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">x_i</span><span class="o">-</span><span class="n">hrad</span><span class="p">:</span><span class="n">x_i</span><span class="o">+</span><span class="n">hrad</span><span class="p">,</span> <span class="n">y_i</span><span class="o">-</span><span class="n">hrad</span><span class="p">:</span><span class="n">y_i</span><span class="o">+</span><span class="n">hrad</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub</span><span class="p">))</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub</span><span class="p">))</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">sub</span><span class="o">.</span><span class="n">shape</span>
    
        <span class="c1">#(xdata_tuple, amplitude, xo, yo, def_fwhm, def_fwhm, theta, offset):</span>
        <span class="n">def_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">def_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">initial_guess</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">def_x</span><span class="p">,</span> <span class="n">def_y</span><span class="p">,</span> <span class="n">def_fwhm</span><span class="p">,</span> <span class="n">def_fwhm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
        <span class="n">detected</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">curve_fit</span><span class="p">(</span><span class="n">twoD_Gaussian</span><span class="p">,</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">),</span> <span class="n">sub</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">p0</span><span class="o">=</span><span class="n">initial_guess</span><span class="p">)</span>
            <span class="n">fwhm_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">fwhm_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">amplitude</span><span class="o">=</span><span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">background</span><span class="o">=</span><span class="n">popt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">detected</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">fwhm_x</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">fwhm_y</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">amplitude</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">background</span> <span class="o">=</span> <span class="mi">0</span>
        
        
        <span class="n">detected</span> <span class="o">=</span> <span class="n">detected</span> <span class="o">*</span> <span class="p">(</span><span class="n">amplitude</span><span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">detected</span><span class="p">):</span>
            <span class="n">fwhm_x</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">fwhm_y</span> <span class="o">=</span> <span class="mi">0</span>     
        
        
        <span class="k">print</span> <span class="n">i</span><span class="p">,</span> <span class="n">detected</span><span class="p">,</span> <span class="s1">&#39;Amplitude </span><span class="si">%.3f</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">amplitude</span><span class="p">,</span> <span class="s1">&#39;BG </span><span class="si">%.3f</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">background</span><span class="p">,</span> <span class="s2">&quot;BG_stats </span><span class="si">%.3f</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="s2">&quot;FWHM_x,FWHM_y=(</span><span class="si">%.3f</span><span class="s2">, </span><span class="si">%.3f</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fwhm_x</span><span class="p">,</span> <span class="n">fwhm_y</span><span class="p">)</span>
        
        <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">detected</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">([</span><span class="n">fwhm_x</span><span class="p">,</span> <span class="n">fwhm_y</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">fwhm_x</span><span class="p">,</span> <span class="n">fwhm_y</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">fwhm_x</span><span class="p">,</span> <span class="n">fwhm_y</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">detected</span> <span class="o">&amp;</span> <span class="n">plot</span><span class="p">):</span>
            <span class="n">data_fitted</span> <span class="o">=</span> <span class="n">twoD_Gaussian</span><span class="p">((</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">),</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span>
            
            <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">data_fitted</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sub</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">5</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sub</span><span class="o">-</span><span class="n">data_fitted</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sub</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">data_fitted</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sub</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">5</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">def_x</span><span class="p">,</span> <span class="n">def_y</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;DETECTED for Position X,Y = </span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">x_i</span><span class="p">,</span><span class="n">y_i</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">imfile</span><span class="p">),</span> <span class="s2">&quot;gauss_</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="n">detected</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">plot</span><span class="p">):</span>           
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;NOT DETECTED for Position X,Y = </span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">x_i</span><span class="p">,</span><span class="n">y_i</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">imfile</span><span class="p">),</span> <span class="s2">&quot;gauss_</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="c1">#plt.show()</span>
            
    <span class="k">return</span> <span class="n">out</span></div>
    
    
<div class="viewcode-block" id="extract_star_sequence"><a class="viewcode-back" href="../../SEDMrph.html#SEDMrph.zeropoint.extract_star_sequence">[docs]</a><span class="k">def</span> <span class="nf">extract_star_sequence</span><span class="p">(</span><span class="n">imfile</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">survey</span><span class="o">=</span><span class="s1">&#39;sdss&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">refstars</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">plotdir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Given a fits image: imfile and a the name of the band which we want to extract the sources from,</span>
<span class="sd">    it saves the extracted sources into  &#39;/tmp/sdss_cat_det.txt&#39; file.</span>
<span class="sd">    If the band does not match the bands in the survey, a change is performed to adapt to the new band.</span>
<span class="sd">    </span>
<span class="sd">    If plotting activated, plots the USNOB1 field of stars on top of the star field image.</span>
<span class="sd">    Red circles are stars identified from the catalogue in the correct magnitude range.</span>
<span class="sd">    Yellow circles are stars that are isolated.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">survey</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">survey</span><span class="p">)</span>
    
    <span class="n">f</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">imfile</span><span class="p">)</span>
    <span class="n">wcs</span> <span class="o">=</span> <span class="n">pywcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">img</span><span class="p">[</span><span class="n">img</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">wcs_pix2sky</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ra0</span><span class="p">,</span> <span class="n">dec0</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">wcs_pix2sky</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">sr</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dec</span><span class="o">-</span><span class="n">dec0</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">ra</span><span class="p">,</span><span class="n">dec</span><span class="p">,</span> <span class="n">sr</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">refstars</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">refstars</span><span class="p">,</span> <span class="s2">&quot;/tmp/tmp_sdss.cat&quot;</span><span class="p">)</span>
        <span class="n">catalog</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="s2">&quot;/tmp/tmp_sdss.cat&quot;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="n">cat_ra</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span>
        <span class="n">cat_dec</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mag</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;R&quot;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">mag</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">]</span>
        
    <span class="k">elif</span> <span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">survey</span><span class="p">)</span> <span class="o">==</span><span class="s1">&#39;usnob1&#39;</span><span class="p">:</span>
        <span class="c1">#ra, dec = coordinates_conversor.hour2deg(f[0].header[&#39;RA&#39;], f[0].header[&#39;DEC&#39;])</span>
        <span class="c1">#SEDM FoV is 6.5 arcmin, due to uncertainties in the position, 4 arcmin radius assumed.</span>
        <span class="c1"># Download USNO-B1 catalog for the position</span>
        <span class="n">catalog_url</span> <span class="o">=</span> <span class="s1">&#39;http://www.nofs.navy.mil/cgi-bin/vo_cone.cgi?CAT=USNO-B1&amp;RA=</span><span class="si">%.5f</span><span class="s1">&amp;DEC=</span><span class="si">%.5f</span><span class="s1">&amp;SR=</span><span class="si">%.4f</span><span class="s1">&amp;VERB=1&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">sr</span><span class="p">)</span>
        <span class="k">print</span> <span class="s2">&quot;Downloading USNO-B1 catalog...&quot;</span>
        <span class="n">urllib</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">catalog_url</span><span class="p">,</span> <span class="s1">&#39;/tmp/tmp.cat&#39;</span><span class="p">)</span>
        
        <span class="c1"># Read RA, Dec and magnitude from XML format USNO catalog</span>
        <span class="n">catalog</span> <span class="o">=</span> <span class="n">parse_single_table</span><span class="p">(</span><span class="s2">&quot;/tmp/tmp.cat&quot;</span><span class="p">)</span>
        <span class="n">cat_ra</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">cat_dec</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">cat_R1mag</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="s1">&#39;R1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">cat_R2mag</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="s1">&#39;R2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">cat_B1mag</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="s1">&#39;B1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">cat_B2mag</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="s1">&#39;B2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">cat_I2mag</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="s1">&#39;I2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        
        <span class="n">cat_R1mag</span><span class="p">[</span><span class="n">cat_R1mag</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">cat_R2mag</span><span class="p">[</span><span class="n">cat_R2mag</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">cat_B1mag</span><span class="p">[</span><span class="n">cat_B1mag</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">cat_B2mag</span><span class="p">[</span><span class="n">cat_B2mag</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">cat_I2mag</span><span class="p">[</span><span class="n">cat_I2mag</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="n">Bmag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cat_B1mag</span><span class="p">,</span> <span class="n">cat_B2mag</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>    
        <span class="n">Rmag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cat_R1mag</span><span class="p">,</span> <span class="n">cat_R2mag</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>    
        <span class="n">Imag</span> <span class="o">=</span> <span class="n">cat_I2mag</span>
            
        <span class="n">mag</span> <span class="o">=</span> <span class="n">Rmag</span>
    <span class="k">elif</span> <span class="n">survey</span> <span class="o">==</span> <span class="s2">&quot;apass&quot;</span><span class="p">:</span>
        <span class="c1"># Download USNO-B1 catalog for the position</span>
        <span class="n">catalog_url</span> <span class="o">=</span> <span class="s1">&#39;https://www.aavso.org/cgi-bin/apass_download.pl?ra=</span><span class="si">%.5f</span><span class="s1">&amp;dec=</span><span class="si">%.5f</span><span class="s1">&amp;radius=</span><span class="si">%.4f</span><span class="s1">8&amp;outtype=1&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">sr</span><span class="p">)</span>
        <span class="k">print</span> <span class="s2">&quot;Downloading APASS catalog...&quot;</span>
        <span class="n">urllib</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">catalog_url</span><span class="p">,</span> <span class="s1">&#39;/tmp/tmp_apass.cat&#39;</span><span class="p">)</span>
        <span class="n">catalog</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="s2">&quot;/tmp/tmp_apass.cat&quot;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">catalog</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">False</span>
        <span class="n">cat_ra</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;radeg&#39;</span><span class="p">]</span>
        <span class="n">cat_dec</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;decdeg&#39;</span><span class="p">]</span>
        <span class="n">mag</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;Sloan_r&#39;</span><span class="p">]</span>
        
    <span class="k">elif</span> <span class="p">(</span><span class="n">survey</span><span class="o">==</span><span class="s1">&#39;sdss&#39;</span><span class="p">):</span>
        <span class="n">minmag</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="n">maxmag</span> <span class="o">=</span> <span class="mf">22.0</span>
        <span class="n">catalog_url</span><span class="o">=</span><span class="s1">&#39;http://skyserver.sdss.org/dr7/en/tools/search/x_radial.asp?ra=</span><span class="si">%.5f</span><span class="s1">&amp;dec=</span><span class="si">%.5f</span><span class="s1">&amp;check_type=type&amp;type=6</span><span class="se">\</span>
<span class="s1">        &amp;radius=</span><span class="si">%.4f</span><span class="s1">&amp;check_u=u&amp;min_u=</span><span class="si">%.2f</span><span class="s1">&amp;max_u=</span><span class="si">%.2f</span><span class="s1">&amp;check_g=g&amp;min_g=</span><span class="si">%.2f</span><span class="s1">&amp;max_g=</span><span class="si">%.2f</span><span class="s1">&amp;check_r=r&amp;min_r=</span><span class="si">%.2f</span><span class="s1">&amp;max_r=</span><span class="si">%.2f</span><span class="s1">&amp;check_i=i&amp;min_i=</span><span class="si">%.2f</span><span class="s1">&amp;max_i=</span><span class="si">%.2f</span><span class="s1">&amp;check_z=z&amp;min_z=</span><span class="si">%.2f</span><span class="s1">&amp;max_z=</span><span class="si">%.2f</span><span class="s1">&amp;entries=top&amp;topnum=500&amp;format=csv&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">sr</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span><span class="n">minmag</span><span class="p">,</span><span class="n">maxmag</span><span class="p">,</span><span class="n">minmag</span><span class="p">,</span><span class="n">maxmag</span><span class="p">,</span><span class="n">minmag</span><span class="p">,</span><span class="n">maxmag</span><span class="p">,</span><span class="n">minmag</span><span class="p">,</span><span class="n">maxmag</span><span class="p">,</span><span class="n">minmag</span><span class="p">,</span><span class="n">maxmag</span><span class="p">)</span>
        <span class="k">print</span> <span class="s2">&quot;Downloading SDSS catalog...&quot;</span>
        <span class="k">print</span> <span class="n">catalog_url</span>
        <span class="n">urllib</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">catalog_url</span><span class="p">,</span> <span class="s1">&#39;/tmp/tmp_sdss.cat&#39;</span><span class="p">)</span>
        <span class="n">catalog</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="s2">&quot;/tmp/tmp_sdss.cat&quot;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">catalog</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
	    <span class="k">return</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cat_ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cat_dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="ow">in</span> <span class="n">catalog</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">):</span>
                <span class="k">print</span> <span class="s2">&quot;SDSS filter detected&quot;</span>
                <span class="n">mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">catalog</span><span class="p">[</span><span class="n">band</span><span class="p">],</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span><span class="p">(</span><span class="n">band</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;V&quot;</span><span class="p">,</span> <span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">]):</span>
                <span class="k">print</span> <span class="s2">&quot;Johnson filter detected.&quot;</span>
                <span class="n">john</span> <span class="o">=</span> <span class="n">transformations</span><span class="o">.</span><span class="n">sdss2johnson</span><span class="p">(</span><span class="s2">&quot;/tmp/tmp_sdss.cat&quot;</span><span class="p">,</span> <span class="n">savefile</span><span class="o">=</span><span class="s2">&quot;/tmp/tmp_sdss.cat&quot;</span><span class="p">)</span>
                <span class="n">mag</span> <span class="o">=</span> <span class="n">john</span><span class="p">[</span><span class="n">band</span><span class="p">]</span>
                <span class="n">catalog</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="s2">&quot;/tmp/tmp_sdss.cat&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;Unknown band!!&quot;</span><span class="p">,</span> <span class="n">band</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">&quot;Problems with SDSS image&quot;</span><span class="p">,</span> <span class="n">band</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">&quot;Problems with the catalogue for the image&quot;</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="c1">#Convert ra, dec position of all stars to pixels.</span>
    <span class="n">star_pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cat_ra</span><span class="p">)):</span>
        <span class="c1"># Get pixel coordinates of USNO stars</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">wcs_sky2pix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cat_ra</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cat_dec</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">star_pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">row_stack</span><span class="p">((</span><span class="n">star_pix</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
    
    <span class="n">star_pix</span> <span class="o">=</span> <span class="n">star_pix</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">pix2ang</span> <span class="o">=</span> <span class="mf">0.394</span>
    <span class="n">rad</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">25.</span><span class="o">/</span><span class="n">pix2ang</span><span class="p">)</span>
    <span class="c1">#Select only the stars within the image.</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">star_pix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;-</span><span class="n">rad</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">star_pix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">rad</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">star_pix</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;-</span><span class="n">rad</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">star_pix</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">rad</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="s1">&#39;u&#39;</span><span class="p">):</span>    
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">*</span> <span class="p">(</span><span class="n">mag</span> <span class="o">&lt;</span> <span class="mi">19</span><span class="p">)</span>
    <span class="c1">#Select only stars isolated in a radius of ~12 arcsec.</span>
    <span class="n">mask2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">are_isolated</span><span class="p">(</span><span class="n">cat_ra</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">cat_dec</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="mf">15.</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask2</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
	<span class="k">print</span> <span class="s2">&quot;No stars left&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mask2</span>
	<span class="k">return</span> <span class="bp">False</span>   
    <span class="c1">#Select only stars that are within the proper magnitude range</span>
    <span class="n">mask3</span> <span class="o">=</span> <span class="p">(</span><span class="n">mag</span><span class="p">[</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">20.</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">mag</span><span class="p">[</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span> 
    
    <span class="n">mask3</span> <span class="o">=</span> <span class="n">mask3</span> <span class="o">*</span> <span class="p">(</span><span class="n">star_pix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">]</span><span class="o">&gt;</span><span class="n">rad</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">star_pix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">]</span><span class="o">&lt;</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">rad</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">star_pix</span><span class="p">[:,</span><span class="mi">1</span><span class="p">][</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">]</span><span class="o">&gt;</span><span class="n">rad</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">star_pix</span><span class="p">[:,</span><span class="mi">1</span><span class="p">][</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">]</span><span class="o">&lt;</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">rad</span><span class="p">)</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">survey</span><span class="o">==</span><span class="s1">&#39;usnob1&#39;</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">star_pix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">][</span><span class="n">mask3</span><span class="p">],</span> <span class="n">star_pix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">][</span><span class="n">mask3</span><span class="p">],</span> \
        <span class="n">cat_ra</span><span class="p">[</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">][</span><span class="n">mask3</span><span class="p">],</span> <span class="n">cat_dec</span><span class="p">[</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">][</span><span class="n">mask3</span><span class="p">],</span> <span class="n">Bmag</span><span class="p">[</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">][</span><span class="n">mask3</span><span class="p">],</span> <span class="n">Rmag</span><span class="p">[</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">][</span><span class="n">mask3</span><span class="p">],</span> <span class="n">Imag</span><span class="p">[</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">][</span><span class="n">mask3</span><span class="p">]))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s1">&#39;/tmp/usnob1_cat.txt&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.5f</span><span class="s2"> </span><span class="si">%.5f</span><span class="s2"> </span><span class="si">%.5f</span><span class="s2"> </span><span class="si">%.5f</span><span class="s2"> </span><span class="si">%.5f</span><span class="s2"> </span><span class="si">%.5f</span><span class="s2"> </span><span class="si">%.5f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="s1">&#39;#X Y ra dec B R I&#39;</span><span class="p">)</span>
        <span class="k">print</span> <span class="s2">&quot;Saved to&quot;</span><span class="p">,</span> <span class="s1">&#39;/tmp/usnob1_cat.txt&#39;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">survey</span><span class="o">==</span><span class="s1">&#39;apass&#39;</span><span class="p">):</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask2</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask3</span><span class="p">):</span>
            <span class="k">print</span> <span class="n">star_pix</span>
            <span class="k">print</span> <span class="s2">&quot;No stars left...&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mask2</span><span class="p">,</span> <span class="n">mask3</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">catalog</span><span class="p">[</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">][</span><span class="n">mask3</span><span class="p">]</span>

        <span class="n">catalog</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">][</span><span class="n">mask3</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">star_pix</span><span class="p">[</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">][</span><span class="n">mask3</span><span class="p">]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;f8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">)])</span>
        <span class="n">z</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">z</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                
        <span class="k">for</span> <span class="n">n</span>  <span class="ow">in</span> <span class="n">catalog</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">rfn</span><span class="o">.</span><span class="n">append_fields</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">catalog</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">usemask</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
           
        <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.5f</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">fmt</span> <span class="o">+=</span>  <span class="s2">&quot; </span><span class="si">%.5f</span><span class="s2">&quot;</span>

        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s1">&#39;/tmp/apass_cat.txt&#39;</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">,</span> \
        <span class="n">header</span><span class="o">=</span><span class="s1">&#39;x y radeg raerr decdeg decerr number_of_Obs V dV B dB g dg r dr i di&#39;</span><span class="p">)</span>
        <span class="k">print</span> <span class="s2">&quot;Saved to&quot;</span><span class="p">,</span> <span class="s1">&#39;/tmp/apass_cat.txt&#39;</span>
    <span class="k">elif</span> <span class="n">survey</span><span class="o">==</span><span class="s1">&#39;sdss&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask2</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask3</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">catalog</span><span class="p">[</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">][</span><span class="n">mask3</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">star_pix</span>
            <span class="k">print</span> <span class="s2">&quot;No stars left...&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mask2</span><span class="p">,</span> <span class="n">mask3</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">catalog</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">][</span><span class="n">mask3</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">star_pix</span><span class="p">[</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">][</span><span class="n">mask3</span><span class="p">]</span>

            <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;f8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">)])</span>
            <span class="n">z</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">z</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                    
            <span class="k">print</span> <span class="s2">&quot;NAMES&quot;</span><span class="p">,</span><span class="n">catalog</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span>
            <span class="n">header</span><span class="o">=</span><span class="s1">&#39;x y &#39;</span>
            <span class="k">for</span> <span class="n">n</span>  <span class="ow">in</span> <span class="n">catalog</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;objid&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="s2">&quot;dec&quot;</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;Err_u&quot;</span><span class="p">,</span> <span class="s2">&quot;Err_g&quot;</span><span class="p">,</span> <span class="s2">&quot;Err_r&quot;</span><span class="p">,</span> <span class="s2">&quot;Err_i&quot;</span><span class="p">,</span> <span class="s2">&quot;Err_z&quot;</span><span class="p">]:</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">rfn</span><span class="o">.</span><span class="n">append_fields</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">catalog</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">usemask</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="n">header</span> <span class="o">+=</span> <span class="n">n</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Err_&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
               
            <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.5f</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">fmt</span> <span class="o">+=</span>  <span class="s2">&quot; </span><span class="si">%.5f</span><span class="s2">&quot;</span>
    
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s1">&#39;/tmp/sdss_cat.txt&#39;</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="p">)</span>
            <span class="k">print</span> <span class="s2">&quot;Saved to&quot;</span><span class="p">,</span> <span class="s1">&#39;/tmp/sdss_cat.txt&#39;</span>
            
            <span class="c1">#Find FWHM for this image            </span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">find_fwhm</span><span class="p">(</span><span class="n">imfile</span><span class="p">,</span> <span class="n">star_pix</span><span class="p">[:,</span><span class="mi">1</span><span class="p">][</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">][</span><span class="n">mask3</span><span class="p">],</span> <span class="n">star_pix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">][</span><span class="n">mask3</span><span class="p">],</span> <span class="n">plot</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
            <span class="n">mask_valid_fwhm</span> <span class="o">=</span> <span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;detected&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;e&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0.7</span><span class="p">)</span> <span class="o">*</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;fwhm&#39;</span><span class="p">]</span><span class="o">*</span> <span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;fwhm&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">))</span>            

            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">mask_valid_fwhm</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">):</span>
                <span class="k">print</span> <span class="s2">&quot;ERROR with FWHM!! Too few points for a valid estimation. &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">mask_valid_fwhm</span><span class="p">),</span> <span class="s2">&quot;) points&quot;</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="n">outd</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">mask_valid_fwhm</span><span class="p">]</span>

            <span class="k">print</span> <span class="s1">&#39;Average FWHM&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">outd</span><span class="p">[</span><span class="s1">&#39;fwhm&#39;</span><span class="p">]),</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">outd</span><span class="p">[</span><span class="s1">&#39;fwhm&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">pix2ang</span><span class="p">,</span> <span class="s1">&#39;pixels&#39;</span>
            
            <span class="n">fwhm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">outd</span><span class="p">[</span><span class="s1">&#39;fwhm&#39;</span><span class="p">])</span>
            <span class="n">fitsutils</span><span class="o">.</span><span class="n">update_par</span><span class="p">(</span><span class="n">imfile</span><span class="p">,</span><span class="s1">&#39;FWHM&#39;</span><span class="p">,</span><span class="n">fwhm</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="ow">in</span> <span class="s1">&#39;ugriz&#39;</span><span class="p">):</span>
                <span class="n">header</span><span class="o">=</span><span class="s1">&#39;x y objid ra dec u g r i z du dg dr di dz&#39;</span>
            <span class="k">elif</span> <span class="n">band</span> <span class="ow">in</span> <span class="s1">&#39;UBVRI&#39;</span><span class="p">:</span>
                <span class="n">header</span><span class="o">=</span><span class="s1">&#39;x y objid ra dec U B V R I dU dB dV dR dI&#39;</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s1">&#39;/tmp/sdss_cat_det.txt&#39;</span><span class="p">,</span> <span class="n">z</span><span class="p">[</span><span class="n">mask_valid_fwhm</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">,</span> \
            <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
            <span class="k">print</span> <span class="s2">&quot;Saved to&quot;</span><span class="p">,</span> <span class="s1">&#39;/tmp/sdss_cat_det.txt&#39;</span>
            
            
        
    <span class="c1">#Plot results</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span> <span class="o">=</span> <span class="n">zscale</span><span class="o">.</span><span class="n">zscale</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        
    <span class="k">print</span> <span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> stars in </span><span class="si">%s</span><span class="s2">. &quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cat_dec</span><span class="p">),</span> <span class="n">survey</span><span class="p">),</span> \
            <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> of them within the FoV. &quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">cat_ra</span><span class="p">[</span><span class="n">mask</span><span class="p">]),</span>\
            <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> of them are isolated.&quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">cat_ra</span><span class="p">[</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">]),</span>\
            <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> of them with suitable magnitudes. &quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">cat_ra</span><span class="p">[</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">][</span><span class="n">mask3</span><span class="p">]),</span>\
            <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> of them with detected stars.&quot;</span><span class="o">%</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">mask_valid_fwhm</span><span class="p">)</span> 
    
    
    <span class="k">if</span> <span class="p">(</span><span class="n">plot</span><span class="p">):</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray_r</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">zmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">zmax</span><span class="p">)</span>

        
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">star_pix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>        
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">star_pix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="n">star_pix</span><span class="p">[:,</span><span class="mi">1</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">10000</span><span class="o">*</span><span class="p">(</span><span class="mf">10.</span><span class="o">/</span><span class="n">mag</span><span class="p">[</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">])</span><span class="o">**</span><span class="mi">9</span><span class="p">),</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;catalogue&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">star_pix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">])</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>        
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">star_pix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">],</span> <span class="n">star_pix</span><span class="p">[:,</span><span class="mi">1</span><span class="p">][</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;isolated&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">star_pix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">][</span><span class="n">mask3</span><span class="p">])</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>        
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">star_pix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">][</span><span class="n">mask3</span><span class="p">],</span> <span class="n">star_pix</span><span class="p">[:,</span><span class="mi">1</span><span class="p">][</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">][</span><span class="n">mask3</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;wihtin farme and mag&quot;</span><span class="p">)</span>


        <span class="n">selected</span> <span class="o">=</span> <span class="n">star_pix</span><span class="p">[:,:][</span><span class="n">mask</span><span class="p">][</span><span class="n">mask2</span><span class="p">][</span><span class="n">mask3</span><span class="p">][</span><span class="n">mask_valid_fwhm</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">selected</span><span class="p">)</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>        
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">selected</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">selected</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> \
                <span class="n">s</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">selected</span><span class="p">)):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">selected</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="n">selected</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">plotdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">imfile</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;.seqstars.png&#39;</span><span class="p">)))</span>
        <span class="k">print</span> <span class="s2">&quot;Saved stars to &quot;</span><span class="p">,</span><span class="n">imfile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;.seqstars.png&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        
    <span class="k">return</span> <span class="bp">True</span></div>
        
<div class="viewcode-block" id="add_to_zp_cal"><a class="viewcode-back" href="../../SEDMrph.html#SEDMrph.zeropoint.add_to_zp_cal">[docs]</a><span class="k">def</span> <span class="nf">add_to_zp_cal</span><span class="p">(</span><span class="n">ref_stars</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">logname</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Records the parameters and instrumental and standard star magnitudes needed for zeropoint calibration.</span>
<span class="sd">    ref_stars: name of the file that contains the reference stars that are present in the image.</span>
<span class="sd">    image: fits image with the sources in them.</span>
<span class="sd">    logname: name of the file where the information on reference and measurements are logged.</span>
<span class="sd">    </span>
<span class="sd">    minst = M + c0 + c1(AIRMASS) + c2(color) + c3(UT)    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">coldic</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;u&#39;</span><span class="p">:</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">:</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span><span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">:</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span><span class="s1">&#39;R&#39;</span><span class="p">}</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">ref_stars</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">my</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">image</span><span class="o">+</span><span class="s2">&quot;.app.mag&quot;</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;f4&quot;</span><span class="p">),</span>  <span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;f4&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;f4&quot;</span><span class="p">),(</span><span class="s2">&quot;Xshift&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;f4&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;Yshift&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;f4&quot;</span><span class="p">),(</span><span class="s2">&quot;fwhm&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;f4&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;ph_mag&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;f4&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;stdev&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;f4&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;fit_mag&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;f4&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;fiterr&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;f4&quot;</span><span class="p">)])</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">my</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">my</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">my</span><span class="p">])</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">r</span><span class="p">])</span>
    
    <span class="n">band</span> <span class="o">=</span> <span class="n">fitsutils</span><span class="o">.</span><span class="n">get_par</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s1">&#39;filter&#39;</span><span class="p">)</span>
    <span class="n">mask_valid1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">my</span><span class="p">[</span><span class="s2">&quot;fwhm&quot;</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">9000</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">my</span><span class="p">[</span><span class="s2">&quot;ph_mag&quot;</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">9000</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="o">~</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">band</span><span class="p">]))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="o">~</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">my</span><span class="p">[</span><span class="s2">&quot;fit_mag&quot;</span><span class="p">]))</span>
    
    <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">mask_valid1</span><span class="p">]</span>
    <span class="n">my</span> <span class="o">=</span> <span class="n">my</span><span class="p">[</span><span class="n">mask_valid1</span><span class="p">]</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    
    <span class="n">my</span><span class="p">[</span><span class="s2">&quot;fiterr&quot;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span> <span class="n">my</span><span class="p">[</span><span class="s2">&quot;fiterr&quot;</span><span class="p">])]</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="n">col_band</span> <span class="o">=</span> <span class="n">coldic</span><span class="p">[</span><span class="n">band</span><span class="p">]</span>
    <span class="n">exptime</span> <span class="o">=</span> <span class="n">fitsutils</span><span class="o">.</span><span class="n">get_par</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;exptime&quot;</span><span class="p">)</span>
    <span class="n">airmass</span> <span class="o">=</span> <span class="n">fitsutils</span><span class="o">.</span><span class="n">get_par</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;AIRMASS&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fitsutils</span><span class="o">.</span><span class="n">has_par</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;JD&quot;</span><span class="p">)):</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">fitsutils</span><span class="o">.</span><span class="n">get_par</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;JD&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">fitsutils</span><span class="o">.</span><span class="n">has_par</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;MJD&quot;</span><span class="p">)):</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">fitsutils</span><span class="o">.</span><span class="n">get_par</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;MJD&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">fitsutils</span><span class="o">.</span><span class="n">has_par</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;MJD-OBS&quot;</span><span class="p">)):</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">fitsutils</span><span class="o">.</span><span class="n">get_par</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;MJD-OBS&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">date</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">logname</span><span class="p">)):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">logname</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#filename,filter,std,stderr,inst,insterr,jd,airmass,color,exptime</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">logname</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%.3f</span><span class="s2">,</span><span class="si">%.3f</span><span class="s2">,</span><span class="si">%3f</span><span class="s2">,</span><span class="si">%.3f</span><span class="s2">,</span><span class="si">%.3f</span><span class="s2">,</span><span class="si">%.3f</span><span class="s2">,</span><span class="si">%.3f</span><span class="s2">,</span><span class="si">%.3f</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span>
            <span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">band</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;d&quot;</span><span class="o">+</span><span class="n">band</span><span class="p">],</span> <span class="n">my</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;fit_mag&#39;</span><span class="p">],</span> <span class="n">my</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;fiterr&#39;</span><span class="p">],</span> <span class="n">date</span><span class="p">,</span> <span class="n">airmass</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">band</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">col_band</span><span class="p">],</span><span class="n">exptime</span><span class="p">))</span></div>

<div class="viewcode-block" id="lsq_test"><a class="viewcode-back" href="../../SEDMrph.html#SEDMrph.zeropoint.lsq_test">[docs]</a><span class="k">def</span> <span class="nf">lsq_test</span><span class="p">():</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    
    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    
    <span class="n">D</span> <span class="o">=</span> <span class="mi">23</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">X</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">Y</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span>
    <span class="n">O</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
    
    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">flatten</span><span class="p">()),</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">M</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> 
    <span class="n">M</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">M</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    
    <span class="n">depend</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">-</span> <span class="n">O</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        
    <span class="n">lsq_result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">depend</span><span class="p">)</span>
    <span class="n">coef</span> <span class="o">=</span> <span class="n">lsq_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">lsq_result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="k">print</span> <span class="n">coef</span><span class="p">,</span> <span class="n">res</span>
    
    <span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">depend</span> <span class="o">-</span><span class="n">coef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span><span class="n">Y</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">*</span><span class="n">coef</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>  <span class="n">X</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">*</span><span class="n">coef</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span>

    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">depend</span> <span class="o">-</span><span class="n">coef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span><span class="n">X</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">*</span><span class="n">coef</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>  <span class="n">Y</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">*</span><span class="n">coef</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
        
<div class="viewcode-block" id="lsq_zeropoint"><a class="viewcode-back" href="../../SEDMrph.html#SEDMrph.zeropoint.lsq_zeropoint">[docs]</a><span class="k">def</span> <span class="nf">lsq_zeropoint</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">plotdir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Uses least squares approach to compute the optimum coefficients for ZP, colour term, airmass and time.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">a</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">])</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;u&#39;</span><span class="p">:</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">:</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span><span class="s1">&#39;orange&#39;</span><span class="p">}</span>


    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]):</span>
        <span class="n">ab</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">b</span><span class="p">]</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ab</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">M</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>      
        <span class="c1">#M[:,1] = ab[&#39;inst&#39;]</span>
        <span class="n">M</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> 
        <span class="n">M</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.3</span>
        <span class="n">M</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span> 
        
        <span class="c1">#print M</span>
        
        <span class="n">depend</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;inst&#39;</span><span class="p">]</span>
        
        <span class="n">lsq_result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">depend</span><span class="p">)</span>
        <span class="n">coef</span> <span class="o">=</span> <span class="n">lsq_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">lsq_result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                
        <span class="k">print</span> <span class="s2">&quot;Band&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="s2">&quot;zp </span><span class="si">%.2f</span><span class="s2">, col </span><span class="si">%.2f</span><span class="s2"> , airmass </span><span class="si">%.3f</span><span class="s2"> , time </span><span class="si">%.2f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">coef</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coef</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coef</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">coef</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="s2">&quot;Residuals&quot;</span><span class="p">,</span> <span class="n">res</span>
        
        <span class="n">emp_col</span> <span class="o">=</span> <span class="n">depend</span> <span class="o">-</span><span class="n">coef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span><span class="p">(</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span><span class="o">-</span><span class="mf">1.3</span><span class="p">)</span><span class="o">*</span><span class="n">coef</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">coef</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">pred_col</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">coef</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">mask_col_outlier</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">emp_col</span> <span class="o">-</span> <span class="n">pred_col</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">funcs</span><span class="o">.</span><span class="n">median_absolute_deviation</span><span class="p">(</span><span class="n">emp_col</span> <span class="o">-</span> <span class="n">pred_col</span><span class="p">)</span>


        <span class="n">emp_airmass</span> <span class="o">=</span> <span class="n">depend</span> <span class="o">-</span><span class="n">coef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">coef</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">coef</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">pred_airmass</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">coef</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">mask_airmass_outlier</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">emp_airmass</span> <span class="o">-</span> <span class="n">pred_airmass</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">funcs</span><span class="o">.</span><span class="n">median_absolute_deviation</span><span class="p">(</span><span class="n">emp_airmass</span> <span class="o">-</span> <span class="n">pred_airmass</span><span class="p">)</span>
        
        <span class="n">emp_jd</span> <span class="o">=</span> <span class="n">depend</span> <span class="o">-</span><span class="n">coef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">coef</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span> <span class="p">(</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span><span class="o">-</span><span class="mf">1.3</span><span class="p">)</span><span class="o">*</span><span class="n">coef</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">pred_jd</span> <span class="o">=</span>  <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">coef</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">mask_col_jd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">emp_jd</span> <span class="o">-</span> <span class="n">pred_jd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">funcs</span><span class="o">.</span><span class="n">median_absolute_deviation</span><span class="p">(</span><span class="n">emp_jd</span> <span class="o">-</span> <span class="n">pred_jd</span><span class="p">)</span>
        
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_col_outlier</span> <span class="o">*</span> <span class="n">mask_airmass_outlier</span> <span class="o">*</span> <span class="n">mask_col_jd</span>
        
        <span class="n">ab</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ab</span><span class="p">),</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">M</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>      
        <span class="c1">#M[:,1] = ab[&#39;inst&#39;]</span>
        <span class="n">M</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> 
        <span class="n">M</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.3</span>
        <span class="n">M</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span> 
        <span class="n">M</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">M</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span>
        <span class="n">M</span><span class="p">[:,</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">4</span>
        <span class="n">M</span><span class="p">[:,</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">5</span>
        
        <span class="c1">#print M</span>
        
        <span class="n">depend</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;inst&#39;</span><span class="p">]</span>
        
        <span class="n">lsq_result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">depend</span><span class="p">)</span>
        <span class="n">coef</span> <span class="o">=</span> <span class="n">lsq_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">lsq_result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
    	<span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s2">&quot;coefs_</span><span class="si">%s</span><span class="s2">.txt&quot;</span><span class="o">%</span><span class="n">b</span><span class="p">,</span> <span class="n">coef</span><span class="p">)</span>
        <span class="n">emp_col</span> <span class="o">=</span> <span class="n">depend</span> <span class="o">-</span><span class="n">coef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span><span class="p">(</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span><span class="o">-</span><span class="mf">1.3</span><span class="p">)</span><span class="o">*</span><span class="n">coef</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">coef</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">coef</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">coef</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="n">coef</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="n">coef</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">pred_col</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">coef</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">emp_airmass</span> <span class="o">=</span> <span class="n">depend</span> <span class="o">-</span><span class="n">coef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">coef</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span> <span class="n">coef</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">coef</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">coef</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="n">coef</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="n">coef</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">pred_airmass</span> <span class="o">=</span> <span class="p">(</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span><span class="o">-</span><span class="mf">1.3</span><span class="p">)</span><span class="o">*</span><span class="n">coef</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">emp_jd</span> <span class="o">=</span> <span class="n">depend</span> <span class="o">-</span><span class="n">coef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">coef</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span> <span class="p">(</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span><span class="o">-</span><span class="mf">1.3</span><span class="p">)</span><span class="o">*</span><span class="n">coef</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">pred_jd</span> <span class="o">=</span>  <span class="n">coef</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">coef</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">coef</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="n">coef</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="n">coef</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">5</span>
                
        <span class="k">if</span> <span class="p">(</span><span class="n">plot</span><span class="p">):</span>
            <span class="n">f</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">],</span> <span class="n">emp_col</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">ms</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">],</span>  <span class="n">pred_col</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">)</span>

            <span class="k">print</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">coef</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">],</span> <span class="n">emp_airmass</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">ms</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">],</span> <span class="n">pred_airmass</span> <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;airmass-1.3&quot;</span><span class="p">)</span>

            <span class="c1">#arr = np.array([ab[&#39;jd&#39;], pred_jd]).T</span>
            <span class="c1">#print arr, arr.shape, arr.dtype</span>
            <span class="c1">#arr.view(dtype=[(&#39;f0&#39;, np.float64), (&#39;f1&#39;, np.float64)]).sort(order=[&#39;f0&#39;], axis=0)</span>
            
            <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">],</span> <span class="n">emp_jd</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">ms</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">],</span> <span class="n">pred_jd</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;jd&quot;</span><span class="p">)</span>   
            
            <span class="n">est_zp</span> <span class="o">=</span> <span class="n">coef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">coef</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span><span class="p">(</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span><span class="o">-</span><span class="mf">1.3</span><span class="p">)</span><span class="o">*</span><span class="n">coef</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">coef</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">coef</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">coef</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="n">coef</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="n">coef</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">5</span>
            <span class="c1">#ax4.plot(ab[&#39;jd&#39;], depend, &quot;*&quot;, color=cols[b], alpha=0.4)</span>
            <span class="c1">#ax4.errorbar(ab[&#39;jd&#39;], est_zp, yerr=ab[&#39;insterr&#39;], marker=&quot;o&quot;, c=cols[b], ls=&quot;none&quot;)</span>
            <span class="n">ax4</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">],</span> <span class="n">depend</span><span class="o">-</span><span class="n">est_zp</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;insterr&#39;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;jd&quot;</span><span class="p">)</span>  
            <span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;night predicted zeropoint&quot;</span><span class="p">)</span>
            <span class="n">ax4</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
	    <span class="k">print</span> <span class="s2">&quot;RMS&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">depend</span><span class="o">-</span><span class="n">est_zp</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">depend</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            
	    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">plotdir</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
	    	<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plotdir</span><span class="p">,</span> <span class="s2">&quot;allstars_</span><span class="si">%s</span><span class="s2">.png&quot;</span><span class="o">%</span><span class="n">b</span><span class="p">))</span>
	    <span class="k">else</span><span class="p">:</span>	
            	<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
        
<div class="viewcode-block" id="lsq_zeropoint_partial"><a class="viewcode-back" href="../../SEDMrph.html#SEDMrph.zeropoint.lsq_zeropoint_partial">[docs]</a><span class="k">def</span> <span class="nf">lsq_zeropoint_partial</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Uses least squares approach to compute the optimum coefficients for ZP, colour term, airmass and time.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
    
    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;insterr&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">0.1</span><span class="p">]</span>
    <span class="n">a</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">])</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;u&#39;</span><span class="p">:</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">:</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span><span class="s1">&#39;orange&#39;</span><span class="p">}</span>


    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]):</span>
        <span class="n">ab</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">b</span><span class="p">]</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ab</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">M</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>      
        <span class="c1">#M[:,1] = ab[&#39;inst&#39;]</span>
        <span class="n">M</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> 

        
        <span class="c1">#print M</span>
        
        <span class="n">depend</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;inst&#39;</span><span class="p">]</span>
        
        <span class="n">lsq_result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">depend</span><span class="p">)</span>
        <span class="n">coef</span> <span class="o">=</span> <span class="n">lsq_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">lsq_result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                
        <span class="k">print</span> <span class="s2">&quot;Band&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="s2">&quot;zp </span><span class="si">%.2f</span><span class="s2">, col </span><span class="si">%.2f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">coef</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coef</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="s2">&quot;Residuals&quot;</span><span class="p">,</span> <span class="n">res</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">plot</span><span class="p">):</span>
            <span class="n">f</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">],</span> <span class="n">depend</span> <span class="o">-</span><span class="n">coef</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">],</span>  <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">coef</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">)</span>
     
    <span class="k">if</span> <span class="p">(</span><span class="n">plot</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
        
<div class="viewcode-block" id="find_zeropoint_noid"><a class="viewcode-back" href="../../SEDMrph.html#SEDMrph.zeropoint.find_zeropoint_noid">[docs]</a><span class="k">def</span> <span class="nf">find_zeropoint_noid</span><span class="p">(</span><span class="n">ref_stars</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">plotdir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Finds the zeropoint by comparig the magnitude of the stars measured in the image,</span>
<span class="sd">    vs. the magnitude of the stars from the reference catalogue.</span>
<span class="sd">    band: band for which we want to measure the zeropoint.</span>
<span class="sd">    col_band: band for the colour term we want to use.</span>
<span class="sd">    </span>
<span class="sd">    returns the zeropoint, the colour term and the standard deviation in the </span>
<span class="sd">    zeropoint from all the measured stars.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">print</span> <span class="s1">&#39;Finding the optimum ZP fit...&#39;</span>
    
    <span class="k">print</span> <span class="n">ref_stars</span>
    
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">ref_stars</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">my</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">image</span><span class="o">+</span><span class="s2">&quot;.app.mag&quot;</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;f4&quot;</span><span class="p">),</span>  <span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;f4&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;f4&quot;</span><span class="p">),(</span><span class="s2">&quot;Xshift&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;f4&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;Yshift&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;f4&quot;</span><span class="p">),(</span><span class="s2">&quot;fwhm&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;f4&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;ph_mag&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;f4&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;stdev&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;f4&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;fit_mag&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;f4&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;fiterr&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;f4&quot;</span><span class="p">)])</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">my</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">my</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">my</span><span class="p">])</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">r</span><span class="p">])</span>
    <span class="n">coldic</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;u&#39;</span><span class="p">:</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">:</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span><span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">:</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span><span class="s1">&#39;R&#39;</span><span class="p">}</span>
    <span class="n">band</span> <span class="o">=</span> <span class="n">fitsutils</span><span class="o">.</span><span class="n">get_par</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s1">&#39;filter&#39;</span><span class="p">)</span>
    <span class="n">col_band</span> <span class="o">=</span> <span class="n">coldic</span><span class="p">[</span><span class="n">band</span><span class="p">]</span>
    
    <span class="n">mask_valid1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">my</span><span class="p">[</span><span class="s2">&quot;fwhm&quot;</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">9000</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">my</span><span class="p">[</span><span class="s2">&quot;ph_mag&quot;</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">9000</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="o">~</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">band</span><span class="p">]))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="o">~</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">my</span><span class="p">[</span><span class="s2">&quot;fit_mag&quot;</span><span class="p">]))</span>
    
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">mask_valid1</span><span class="p">]</span>
    <span class="n">my</span> <span class="o">=</span> <span class="n">my</span><span class="p">[</span><span class="n">mask_valid1</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">my</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span> <span class="s2">&quot;Warning, no reliable measurements for file&quot;</span><span class="p">,</span> <span class="n">image</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        
    <span class="n">my</span><span class="p">[</span><span class="s2">&quot;fiterr&quot;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span> <span class="n">my</span><span class="p">[</span><span class="s2">&quot;fiterr&quot;</span><span class="p">])]</span> <span class="o">=</span> <span class="mi">100</span>
    
    <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span><span class="p">[</span><span class="n">mask_valid1</span><span class="p">]</span>
    
    <span class="k">print</span> <span class="n">my</span><span class="p">[</span><span class="s2">&quot;fit_mag&quot;</span><span class="p">]</span>

    <span class="n">coefs</span><span class="p">,</span> <span class="n">residuals</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">singular_values</span><span class="p">,</span> <span class="n">rcond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="n">col_band</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">-</span> <span class="n">my</span><span class="p">[</span><span class="s2">&quot;fit_mag&quot;</span><span class="p">],</span> <span class="n">w</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">my</span><span class="p">[</span><span class="s2">&quot;fiterr&quot;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="o">+</span><span class="n">band</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span> <span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">coefs</span><span class="p">)</span>
    
    <span class="k">print</span> <span class="n">coefs</span>
    
    <span class="n">pred</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="n">col_band</span><span class="p">])</span>
    <span class="n">measured</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-</span> <span class="n">my</span><span class="p">[</span><span class="s2">&quot;fit_mag&quot;</span><span class="p">]</span>
    <span class="n">mad</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">funcs</span><span class="o">.</span><span class="n">median_absolute_deviation</span><span class="p">(</span><span class="n">pred</span><span class="o">-</span><span class="n">measured</span><span class="p">)</span>
    
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pred</span><span class="o">-</span><span class="n">measured</span><span class="p">)</span><span class="o">/</span><span class="n">mad</span> <span class="o">&lt;</span> <span class="mi">15</span>
    
        <span class="k">print</span> <span class="n">mad</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pred</span><span class="o">-</span><span class="n">measured</span><span class="p">),</span>  <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pred</span><span class="o">-</span><span class="n">measured</span><span class="p">)</span><span class="o">/</span><span class="n">mad</span><span class="p">,</span> <span class="n">mask</span>
        
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">my</span> <span class="o">=</span> <span class="n">my</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        
        <span class="n">coefs</span><span class="p">,</span> <span class="n">residuals</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">singular_values</span><span class="p">,</span> <span class="n">rcond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="n">col_band</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">-</span> <span class="n">my</span><span class="p">[</span><span class="s2">&quot;fit_mag&quot;</span><span class="p">],</span> <span class="n">w</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">my</span><span class="p">[</span><span class="s2">&quot;fiterr&quot;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="o">+</span><span class="n">band</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span> <span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="k">print</span> <span class="n">coefs</span>
        
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">coefs</span><span class="p">)</span>
    
        <span class="n">pred</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="n">col_band</span><span class="p">])</span>
        <span class="n">measured</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-</span> <span class="n">my</span><span class="p">[</span><span class="s2">&quot;fit_mag&quot;</span><span class="p">]</span>
        <span class="n">mad</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">funcs</span><span class="o">.</span><span class="n">median_absolute_deviation</span><span class="p">(</span><span class="n">pred</span><span class="o">-</span><span class="n">measured</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="p">(</span><span class="n">plot</span><span class="p">):</span>
        <span class="k">print</span> <span class="s2">&quot;Plotting...&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="n">col_band</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">-</span> <span class="n">my</span><span class="p">[</span><span class="s2">&quot;fit_mag&quot;</span><span class="p">]</span> <span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">my</span><span class="p">[</span><span class="s2">&quot;fiterr&quot;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="o">+</span><span class="n">band</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">myid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="n">col_band</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">my</span><span class="p">[</span><span class="s2">&quot;fit_mag&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">myid</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="n">col_band</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="n">col_band</span><span class="p">]),</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Best fit ZP:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span> <span class="s2">&quot; colour term &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;{:} - {:}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="n">col_band</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;ZP&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">plotdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">image</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s2">&quot;.zp.png&quot;</span><span class="p">)))</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    
    <span class="k">print</span> <span class="n">band</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">col_band</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">pred</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="n">col_band</span><span class="p">])</span>
    <span class="n">measured</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-</span> <span class="n">my</span><span class="p">[</span><span class="s2">&quot;fit_mag&quot;</span><span class="p">]</span>

    <span class="n">fitsutils</span><span class="o">.</span><span class="n">update_par</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;ZP&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">fitsutils</span><span class="o">.</span><span class="n">update_par</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;COLTERM&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">fitsutils</span><span class="o">.</span><span class="n">update_par</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;ZPerr&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">pred</span> <span class="o">-</span> <span class="n">measured</span><span class="p">))</span>


    <span class="k">return</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">pred</span> <span class="o">-</span> <span class="n">measured</span><span class="p">)</span></div>


<div class="viewcode-block" id="calibrate_zeropoint"><a class="viewcode-back" href="../../SEDMrph.html#SEDMrph.zeropoint.calibrate_zeropoint">[docs]</a><span class="k">def</span> <span class="nf">calibrate_zeropoint</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">plotdir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">refstars</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    
    <span class="n">filt</span> <span class="o">=</span> <span class="n">fitsutils</span><span class="o">.</span><span class="n">get_par</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s1">&#39;filter&#39;</span><span class="p">)</span>
    <span class="n">exptime</span> <span class="o">=</span> <span class="n">fitsutils</span><span class="o">.</span><span class="n">get_par</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;exptime&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fitsutils</span><span class="o">.</span><span class="n">has_par</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;JD&quot;</span><span class="p">):</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">fitsutils</span><span class="o">.</span><span class="n">get_par</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;JD&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">fitsutils</span><span class="o">.</span><span class="n">has_par</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;MJD&quot;</span><span class="p">):</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">fitsutils</span><span class="o">.</span><span class="n">get_par</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;MJD&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">fitsutils</span><span class="o">.</span><span class="n">has_par</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;MJD-OBS&quot;</span><span class="p">):</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">fitsutils</span><span class="o">.</span><span class="n">get_par</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;MJD-OBS&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">date</span><span class="o">=</span><span class="mi">0</span>
        
    <span class="n">objname</span> <span class="o">=</span> <span class="n">fitsutils</span><span class="o">.</span><span class="n">get_par</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;OBJECT&quot;</span><span class="p">)</span>
    <span class="n">airmass</span> <span class="o">=</span> <span class="n">fitsutils</span><span class="o">.</span><span class="n">get_par</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;AIRMASS&quot;</span><span class="p">)</span>
    <span class="n">band</span> <span class="o">=</span> <span class="n">fitsutils</span><span class="o">.</span><span class="n">get_par</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;FILTER&quot;</span><span class="p">)</span>
    
    <span class="k">print</span> <span class="s2">&quot;Starting calibration of ZP for image&quot;</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span><span class="s2">&quot;for object&quot;</span><span class="p">,</span> <span class="n">objname</span><span class="p">,</span> <span class="s2">&quot;with filter&quot;</span><span class="p">,</span> <span class="n">band</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">exptime</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">):</span>
        <span class="k">print</span> <span class="s2">&quot;ERROR. Exposure time too short for this image to see anything...&quot;</span>
        <span class="k">return</span> 

    <span class="n">extracted</span> <span class="o">=</span> <span class="n">extract_star_sequence</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">survey</span><span class="o">=</span><span class="s1">&#39;sdss&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> <span class="n">refstars</span><span class="o">=</span><span class="n">refstars</span><span class="p">,</span> <span class="n">plotdir</span><span class="o">=</span><span class="n">plotdir</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">extracted</span><span class="p">):</span>
        <span class="k">print</span> <span class="s2">&quot;Field not in SDSS or error when retrieving the catalogue... Skipping.&quot;</span>
        <span class="k">return</span> 

    <span class="c1">#If extraction worked, we can get the FWHM        </span>
    <span class="n">fwhm</span> <span class="o">=</span> <span class="n">fitsutils</span><span class="o">.</span><span class="n">get_par</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;fwhm&quot;</span><span class="p">)</span>
    <span class="n">fwhm_as</span> <span class="o">=</span> <span class="n">fwhm</span> <span class="o">*</span> <span class="mf">0.394</span>

    <span class="n">app_phot</span><span class="o">.</span><span class="n">get_app_phot</span><span class="p">(</span><span class="s2">&quot;/tmp/sdss_cat_det.txt&quot;</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">wcsin</span><span class="o">=</span><span class="s1">&#39;logic&#39;</span><span class="p">)</span>
    <span class="n">z</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">find_zeropoint_noid</span><span class="p">(</span><span class="s2">&quot;/tmp/sdss_cat_det.txt&quot;</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">plotdir</span><span class="o">=</span><span class="n">plotdir</span><span class="p">)</span>
    
    <span class="c1">#Log the current zeropoint for this image</span>
    <span class="n">logname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">image</span><span class="p">),</span> <span class="s2">&quot;zeropoint.log&quot;</span><span class="p">)</span>
    
    <span class="c1">#Add the data to a later stage zeropoint calibrtion with all-sky data.</span>
    <span class="n">zplogname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">image</span><span class="p">),</span> <span class="s2">&quot;allstars_zp.log&quot;</span><span class="p">)</span>
    
    <span class="n">add_to_zp_cal</span><span class="p">(</span><span class="s2">&quot;/tmp/sdss_cat_det.txt&quot;</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">zplogname</span><span class="p">)</span>


    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">logname</span><span class="p">)):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">logname</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#filename,exptime,filter,date,airmass,fwhm_pix,fwhm_as,zeropoint,color,err</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">logname</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">,</span><span class="si">%.1f</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%3f</span><span class="s2">,</span><span class="si">%.3f</span><span class="s2">,</span><span class="si">%.3f</span><span class="s2">,</span><span class="si">%.3f</span><span class="s2">,</span><span class="si">%.3f</span><span class="s2">,</span><span class="si">%.3f</span><span class="s2">,</span><span class="si">%.3f</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">exptime</span><span class="p">,</span><span class="n">filt</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">airmass</span><span class="p">,</span><span class="n">fwhm</span><span class="p">,</span><span class="n">fwhm_as</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">err</span><span class="p">))</span></div>
        
<div class="viewcode-block" id="plot_zp"><a class="viewcode-back" href="../../SEDMrph.html#SEDMrph.zeropoint.plot_zp">[docs]</a><span class="k">def</span> <span class="nf">plot_zp</span><span class="p">(</span><span class="n">zpfile</span><span class="p">,</span> <span class="n">plotdir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">datetime</span>
    
    <span class="k">def</span> <span class="nf">mkdate</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S&#39;</span><span class="p">)</span> 
    
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">zpfile</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    
    <span class="n">cols</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;u&#39;</span><span class="p">:</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">:</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span><span class="s1">&#39;orange&#39;</span><span class="p">}</span>
    
    <span class="k">for</span> <span class="n">fi</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">fi</span><span class="p">])):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">fi</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">fi</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">*</span><span class="mf">24.</span><span class="p">,</span> \
            <span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">fi</span><span class="p">][</span><span class="s1">&#39;zeropoint&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">fi</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="n">fi</span><span class="p">],</span> <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ecolor</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="n">fi</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">fi</span><span class="p">][</span><span class="s1">&#39;fwhm_pix&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="k">print</span> <span class="s2">&quot;Median zeropoint for filter </span><span class="si">%s</span><span class="s2">: </span><span class="si">%.2f</span><span class="s2"> mag&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">fi</span><span class="p">][</span><span class="s1">&#39;zeropoint&#39;</span><span class="p">]))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Obs Date (JD - min(JD)) [h]&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;ZP [mag]&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">18</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">plotdir</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plotdir</span><span class="p">,</span> <span class="s2">&quot;zeropoint_per_exposure.png&quot;</span><span class="p">))</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="plot_zp_airmass"><a class="viewcode-back" href="../../SEDMrph.html#SEDMrph.zeropoint.plot_zp_airmass">[docs]</a><span class="k">def</span> <span class="nf">plot_zp_airmass</span><span class="p">(</span><span class="n">zpfile</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">datetime</span>
    
    <span class="k">def</span> <span class="nf">mkdate</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S&#39;</span><span class="p">)</span> 
    
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">zpfile</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    
    <span class="n">cols</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;u&#39;</span><span class="p">:</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">:</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span><span class="s1">&#39;orange&#39;</span><span class="p">}</span>
    
    <span class="k">for</span> <span class="n">fi</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">fi</span><span class="p">])):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span> <span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">fi</span><span class="p">][</span><span class="s1">&#39;airmass&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">fi</span><span class="p">][</span><span class="s1">&#39;zeropoint&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">fi</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="n">fi</span><span class="p">],</span> <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ecolor</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="n">fi</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">fi</span><span class="p">][</span><span class="s1">&#39;fwhm_pix&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="k">print</span> <span class="s2">&quot;Median zeropoint for filter </span><span class="si">%s</span><span class="s2">: </span><span class="si">%.2f</span><span class="s2"> mag&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">fi</span><span class="p">][</span><span class="s1">&#39;zeropoint&#39;</span><span class="p">]))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Airmass&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;ZP [mag]&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
    
    
 
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span>\
        <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">        Runs astrometry.net on the image specified as a parameter and returns </span>
<span class="sd">        the offset needed to be applied in order to center the object coordinates </span>
<span class="sd">        in the reference pixel.</span>
<span class="sd">            </span>
<span class="sd">        &#39;&#39;&#39;</span><span class="p">,</span> <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawTextHelpFormatter</span><span class="p">)</span>


    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;reduced&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Directory containing the reduced fits for the night.&#39;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    
    <span class="n">reduced</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">reduced</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">reduced</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
        <span class="k">print</span> <span class="s2">&quot;Please, add the directory containing reduced data as a parameter.&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">reduced</span><span class="p">)</span>
    
    <span class="n">plotdir</span> <span class="o">=</span> <span class="s2">&quot;zeropoint&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">plotdir</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plotdir</span><span class="p">)</span>
    

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.fits&quot;</span><span class="p">):</span>
        <span class="k">print</span> <span class="n">f</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fitsutils</span><span class="o">.</span><span class="n">get_par</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;IMGTYPE&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;SCIENCE&quot;</span><span class="p">):</span>
            <span class="n">calibrate_zeropoint</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">plotdir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">plotdir</span><span class="p">))</span>
    	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;zeropoint.log&quot;</span><span class="p">)):</span>
	    <span class="n">plot_zp</span><span class="p">(</span><span class="s2">&quot;zeropoint.log&quot;</span><span class="p">,</span> <span class="n">plotdir</span><span class="p">)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;allstars_zp.log&quot;</span><span class="p">)):</span>
	    <span class="n">lsq_zeropoint</span><span class="p">(</span><span class="s2">&quot;allstars_zp.log&quot;</span><span class="p">,</span> <span class="n">plotdir</span><span class="p">)</span>

</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Nick Konidaris, Don Neill, Nadia Blagorodnova.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.7</a>
      
    </div>

    

    
  </body>
</html>